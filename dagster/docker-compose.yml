services:
  # Der Webserver (UI)
  dagster-webserver:
    build: .
    restart: always
    environment:
      - DAGSTER_HOME=/opt/dagster/dagster_home
      # DB Vars werden von Coolify injiziert
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
    command: ["dagster-webserver", "-h", "0.0.0.0", "-p", "3000", "-w", "workspace.yaml"]
    healthcheck:
      test: ["CMD-SHELL", "python3 -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:3000/server_info\")' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - coolify

  # Der Daemon (FÃ¼hrt Schedules & Sensoren aus)
  dagster-daemon:
    build: .
    restart: always
    environment:
      - DAGSTER_HOME=/opt/dagster/dagster_home
      # DB Vars werden von Coolify injiziert
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
    command: ["dagster-daemon", "run"]
    networks:
      - coolify
    depends_on:
      - dagster-webserver

networks:
  coolify:
    external: true