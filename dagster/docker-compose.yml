services:
  # Der Webserver (UI)
  dagster-webserver:
    build: .
    restart: always
    environment:
      - DAGSTER_HOME=/opt/dagster/dagster_home
      # DB Vars werden von Coolify injiziert
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
    command: ["dagster-webserver", "-h", "0.0.0.0", "-p", "3000", "-w", "workspace.yaml"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/server_info"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Der Daemon (FÃ¼hrt Schedules & Sensoren aus)
  dagster-daemon:
    build: .
    restart: always
    environment:
      - DAGSTER_HOME=/opt/dagster/dagster_home
      # DB Vars werden von Coolify injiziert
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
    command: ["dagster-daemon", "run"]
    depends_on:
      - dagster-webserver